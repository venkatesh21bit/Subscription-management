# Railway Deployment Guide

## Backend Deployment on Railway

### Quick Start

1. **Create New Project on Railway**
   - Go to [Railway.app](https://railway.app)
   - Click "New Project"
   - Select "Deploy from GitHub repo"

2. **Add PostgreSQL Database**
   - Click "New" → "Database" → "PostgreSQL"
   - Railway will auto-generate `DATABASE_URL`

3. **Configure Backend Service**
   - Root Directory: `/backend`
   - Build Command: `bash build.sh` (or leave default)
   - Start Command: `gunicorn config.wsgi:application --bind 0.0.0.0:$PORT --workers 4 --timeout 120`

### Required Environment Variables

Add these in Railway Dashboard under "Variables" tab:

```bash
# Django Settings (REQUIRED)
SECRET_KEY=your-django-secret-key-here
DJANGO_SETTINGS_MODULE=config.settings.prod
DEBUG=False

# Database (Auto-generated by Railway PostgreSQL service)
DATABASE_URL=postgresql://...

# Twilio Configuration (REQUIRED for Phone OTP)
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=your_twilio_auth_token
TWILIO_PHONE_NUMBER=+1234567890

# Email Configuration (Recommended)
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-specific-password

# Port (Auto-set by Railway)
PORT=8000
```

### Build Configuration

Railway will automatically:
1. Detect Python project
2. Install dependencies from `requirements.txt`
3. Run `build.sh` script which:
   - Collects static files
   - Runs database migrations
4. Start the server with Gunicorn

### Files for Railway Deployment

The following files are configured for Railway:

- **`Procfile`**: Defines release and web processes
- **`railway.toml`**: Railway-specific configuration
- **`build.sh`**: Build script for static files and migrations
- **`requirements.txt`**: Python dependencies
- **`config/settings/prod.py`**: Production settings

### Custom Domain Setup

1. Go to Railway Dashboard → Your Service → Settings
2. Click "Generate Domain" for a free Railway domain
3. Or add custom domain under "Custom Domain" section
4. Update `ALLOWED_HOSTS` in environment variables if needed

### Troubleshooting

#### Static Files Not Loading
- Check Railway logs for collectstatic errors
- Verify `STATIC_ROOT` is set in settings
- Ensure WhiteNoise is in `MIDDLEWARE` (already configured)

#### Database Migrations Not Running
- Check Railway build logs
- Manually run: Go to Railway → Service → Deploy logs
- Or use Railway CLI: `railway run python manage.py migrate`

#### Server Not Starting
- Check if all required environment variables are set
- Verify `SECRET_KEY` is set
- Check `DJANGO_SETTINGS_MODULE=config.settings.prod`
- Look for errors in Deploy logs

#### CORS Errors
- Update `CORS_ALLOWED_ORIGINS` in `config/settings/prod.py`
- Add your frontend URL to the list

### Railway CLI Commands

Install Railway CLI:
```bash
npm i -g @railway/cli
```

Useful commands:
```bash
# Login to Railway
railway login

# Link to your project
railway link

# Run migrations manually
railway run python manage.py migrate

# Collect static files manually
railway run python manage.py collectstatic --noinput

# Open Django shell
railway run python manage.py shell

# View logs
railway logs

# Open service in browser
railway open
```

### Monitoring

- **Deploy Logs**: View build and deployment process
- **HTTP Logs**: Monitor incoming requests
- **Metrics**: CPU, Memory, Network usage in Railway dashboard

### Database Backups

Railway PostgreSQL includes:
- Automatic daily backups (retained for 7 days)
- Point-in-time recovery
- Access via Railway dashboard → Database → Backups

### Scaling

To scale your application:
1. Go to Service Settings
2. Adjust resources (CPU/Memory)
3. Update Gunicorn workers in start command
4. Consider adding Redis for caching

### Security Checklist

- ✅ `DEBUG=False` in production
- ✅ Strong `SECRET_KEY` set
- ✅ `ALLOWED_HOSTS` configured
- ✅ `CORS_ALLOWED_ORIGINS` set properly
- ✅ Database uses SSL (`ssl_require=True`)
- ✅ All sensitive data in environment variables
- ✅ `.env` files not committed to Git

## Frontend Deployment on Railway/Vercel

### Railway Frontend Setup

1. **Create New Service**
   - Deploy from GitHub repo
   - Root Directory: `/frontend`

2. **Environment Variables**
   ```bash
   NEXT_PUBLIC_API_URL=https://backend-production-8d38.up.railway.app/api
   ```

3. **Build Settings**
   - Build Command: `npm run build`
   - Start Command: `npm start`
   - Output Directory: `.next`

### Vercel Frontend Setup (Recommended)

1. Import from GitHub
2. Framework Preset: Next.js
3. Root Directory: `frontend`
4. Add Environment Variable:
   ```
   NEXT_PUBLIC_API_URL=https://backend-production-8d38.up.railway.app/api
   ```
5. Deploy

## Post-Deployment Steps

1. **Test Backend API**
   ```bash
   curl https://your-backend.railway.app/api/
   ```

2. **Create Superuser** (Optional)
   ```bash
   railway run python manage.py createsuperuser
   ```

3. **Access Admin Panel**
   - Visit: `https://your-backend.railway.app/admin/`

4. **Update Frontend URL**
   - Update backend CORS settings if needed
   - Add frontend URL to `CORS_ALLOWED_ORIGINS`

5. **Test Complete Flow**
   - Frontend → Backend API calls
   - Authentication flow
   - Phone OTP (Twilio)
   - Email notifications

## Support

For Railway-specific issues:
- [Railway Documentation](https://docs.railway.app/)
- [Railway Discord](https://discord.gg/railway)
- [Railway Status](https://status.railway.app/)

For application issues:
- Check application logs in Railway dashboard
- Review `DEPLOYMENT_ENV_GUIDE.md`
- Verify all environment variables are set correctly
